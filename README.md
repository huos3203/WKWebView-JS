### WKWebView简介
自iOS8 以后，苹果推出了新框架 WebKit，提供了替换 UIWebView 的组件 WKWebView。各种 UIWebView 的性能问题没有了，速度更快了，占用内存少了，体验更好了，下面列举一些其它的优势:
1. 在性能、稳定性、功能方面有很大提升（加载速度，内存的提升谁用谁知道）
2. 更多的支持 HTML5 的特性
3. 官方宣称的高达60fps的滚动刷新率以及内置手势
4. Safari 相同的 JavaScript 引擎
5.将 UIWebViewDelegate 与 UIWebView 拆分成了14类与3个协议，包含该更细节功能的实现。
### JS调用iOS原生API
#### 结构
![](https://camo.githubusercontent.com/1b0f383f89f1cf9ca6c97f915b6fd943920265ff/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f7376672f584c526c4a7a6a363646786b6c2d393466324f31457a412d4d5837496e35486a6541744a71394f46517253766f4835535a3871533175524d4a6647634e53676c4332596d475758717130506a62353658304b71382d4d5479765f32665f794255797a633947713678332d30786c7456467970786c7976765a675051364b4d38655750435f6737594168326d433368566f637848794141496d5263344a5a4d38625a4b7431685a726c4c5656695972724963594c424579786f53755972515f6a73524f4d4d517748754163307a78534b41754c752d6146452d4a6c514577487a427a453072735476307464664f32424374624e617666496450684157616976516666326e485050305a49576742596775526263416658597659464a53454572663770516b4438784170387155616735447a4969696c6e345765515a557477546f2d3646617249584f415f64395662314745754961434e4577755772356e7764636f4e4649656d446e78755735743038384b745a644c48497a697a756e536245486c5a33474d6c794366497a34703658526c3658666141447572624e3469336358364259722d654c58414b696459693332586643514b33344f7a77687258666a374264532d5f5f516564376b55522d6c6a5f3448304344734d474644764d744e6c316e6945375941765f653254684730386378564b2d3535374a4b4c4c4e684f48675a52686d53696847487a48437064484c61654558616d4f34757162356f6f614d376247636255364b674b764f69364479476943695f346a354a736c4f76426b55323035595f4447456b4f3457496532663932376f6c61396467656f6639304e5734714656507834392d6f6e6d34466a6436586657655478534a536b3172446b50316e4674795f774b674e6c5347466d4d6b32764852707850624b6239667861774e2d44693567686441774370594d793850633255643175627a5a54305176475630426e6b456a555a394b627356472d51593146707646443052665439616457797a323154457651795252533875427468386b346e3158627a685f686a5a5a65734849344a6675445556504a62435337594e6e4b4d64534f48413165655f4e584e666264764b504f6b6c49366246524179733877504342382d365076355872387576307874716a5a5f5a5075535433684c6b714a415676465a49786c48543575556f37307a4f3647743630695079565947467941322d7a4f6f3966306e305865387a447a4967726561686d7869797868544d364c74354d38584643764b4377434d592d4a5548773643674b6d423036424e62615a765735526f4c704578594936775356686e4f6b376770706f50737371723668756769444f776b6348595246724562577937587464497a426e30356a556b384d62756e304e5972584b756468455066786c64664663437a6e4454676a6672586148426f5f52624c586c46686e48544e524752764d69375577647764364a4b4564753632563152774277456662477a524b70356664316f4a424c59726d654c326e47673559584758355365326c6c76617472554b7a46797657502d66423541447a5a745736446e554e5757356d4a327a506f63544a37716b614345736c5f5a6e49515456716b4256744b686f384854455945627a5335582d45765370516f304b466e754364446e4e755641614171414f446c6478745853777679747856546d6666546242366361666d4b4f754e76746b3775676433576454523972494b6670684d513575474b54722d79447a76463038626a7069797869312d566d68486e7674317a7277624e776559623655674669457235534863423459425155526939434841486d516a564e472d42467558456e4a5f6d396d5635456855626b62514765454d3870314162354f683565777a4b63704339324f675a64696e784b415f7438456b2d315844594355714663766b4466654e594e4e744d616756654f3261734467633233516f7672737445414e2d365736785738516141744e754572456a526e3345575950716f4354533363726649334e686d484c6d337a786d73307a6c496933575262664d444d33685756596b32786a6c73364e474f5430586d443648426833335f7a6a656c5252566a39346d32626e44335f526b46367844754a566d703939684b53566a3373386a6446576e547631674875333547334d5f70564749433634335135663336444a4d514a6f5a6e4257775f2d316d3030)

#### 添加监听代理和JS接口
在OC中添加监听的接口清单：以JS脚本的接口`showMobile`为例：
```objc
WKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];
WKUserContentController *userCC = config.userContentController;
//MARK:在OC中添加监听的接口清单：JS脚本的接口名
[userCC addScriptMessageHandler:self name:@"showMobile"];
```
#### 设置userCC的WKScriptMessageHandler代理类
1. 在WK视图控制器的接口处添加该代理
```
@interface ViewController () <WKScriptMessageHandler>
```
2. 在添加js接口监听时，注入代理控制器
```
[userCC addScriptMessageHandler:self name:@"showMobile"];
```
3. 实现代理的回调方法,响应JS接口事件
```
- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {
    NSLog(@"%@",message.body);
}
```

#### JS脚本接口
js接口声明格式：
```
window.webkit.messageHandlers.接口名.postMessage('参数')
```
接口名: 在WKWebView中，当JS执行该接口时，OC会拦截预先监听的接口，并处理相关事件。

参数：object类型，多个参数时需要封装为集合类型来实现多参传递。

当OC拦截到该接口时，可以在`WKScriptMessageHandler`回调方法中的`WKScriptMessage`参数实例中获取该参数值: `message.body`。

三个例子：
1. JS无参调用OC<br/>
当无参调用OC时，参数必须为`null`
```js
window.webkit.messageHandlers.showMobile.postMessage(null)
```

2. JS传参调用OC<br/>
传递单个参数时，直接写入即可，例如：`xiao黄`
```js
window.webkit.messageHandlers.showName.postMessage('xiao黄')
```
传递多个参数时，需要封装为集合类型实现多参传递。<br/>
例如:当传递一个电话，一条信息，需要封装为`['13300001111','Go Climbing This Weekend !!!']`
```js
window.webkit.messageHandlers.showSendMsg.postMessage(['13300001111', 'Go Climbing This Weekend !!!'])
```
### iOS原生API调用JS脚本
在网页加载完成之后调用JS代码才会执行，因为这个时候html页面已经注入到webView中并且可以响应到对应方法。<br/>
例如调用JS函数`alertMobile()`：
```objc
[self.wkWebView evaluateJavaScript:@"alertMobile()" completionHandler:^(id _Nullable response, NSError * _Nullable error) {
                //TODO
                NSLog(@"%@ %@",response,error);
}];
```

#### 在OC中为JS定义属性/函数

* 当注入的类型字符串类型时，必须用`''`括起来。<br/>
* OC注入的参数为全局属性，在html中的JS脚本可以直接调用属性名来获取值。<br/>

通过NSString形式，编写JS脚本，通过以下两种方式注入网页

方式一：在初始化`WKWebView`时，通过配置`WKWebViewConfiguration>userContentController`注入JS脚本  。
```objc
//MARK:向网页中注入JS脚本例如，参数/函数等
WKUserScript *script = [[WKUserScript alloc] initWithSource:@"var number=0;"
                                                injectionTime:WKUserScriptInjectionTimeAtDocumentStart
                                        forMainFrameOnly:YES];
WKUserContentController *userCC = config.userContentController;
[userCC addUserScript:script];
```
方式二：使用WKWebView实例方法`evaluateJavaScript`动态注入JS脚本

```objc
[self.wkWebView evaluateJavaScript:@"var number=0;" completionHandler:nil];
```
#### iOS原生API调用JS函数
使用WKWebView实例方法`evaluateJavaScript`动态调用JS函数
```objc
[self.wkWebView evaluateJavaScript:@"alertSendMsg('18870707070','下午好！')" completionHandler:nil];
```


